# RI (Research Intelligence)

> [English](./README.md) | [中文文档](#)

RI 是一个基于 Electron、React 和 TypeScript 构建的现代终端会话管理器。它旨在通过多会话管理、命令历史追踪、工作流自动化和统一的选项卡界面，帮助开发者高效组织工作流。

![RI 主界面](./docs/images/session.png)

## 功能特性

### 核心功能
- **多终端会话**：创建并管理多个独立的终端进程
- **统一选项卡系统**：所有内容（终端、历史、工作流、设置）在同一个选项卡栏中展示
  - 终端选项卡：显示会话名称（如 "Session 1"）
  - 工作流选项卡：`⚡ 工作流名称` 前缀
  - 历史选项卡：`[H]: 会话名称` 前缀
  - 设置选项卡：`[S]: Settings` 前缀
- **强健的进程管理**：关闭会话时自动清理所有子进程
- **会话持久化**：即使关闭选项卡，会话仍保持运行
- **拖拽排序**：通过拖拽调整选项卡顺序

### 导航与视图
- **图标侧边栏**：快速访问不同视图
  - ⚡ 会话 - 管理终端会话
  - 📁 文件 - 浏览工作区文件
  - 📜 历史 - 查看每个会话的命令历史
  - 🔔 通知 - 监控终端通知
  - 🔧 工作流 - 工作流自动化
  - ⚙ 设置 - 应用配置
- **可折叠导航面板**：左侧面板根据上下文显示会话/历史/工作流列表
- **主从布局**：左侧列表导航，右侧详细内容

### 终端功能
- **完整的 xterm.js 终端模拟**，支持自动适配窗口大小
- **分屏终端支持**：会话内支持水平和垂直分屏
- **命令历史保存**，带会话日志追踪
- **彩色输出支持**，正确处理 ANSI 转义序列
- **自动命名**：首条命令自动为会话命名
- **AI 工具检测**：监控 AI 助手使用状态（OpenCode、Copilot、Aider、Cursor、Cline）
- **安全删除**：上下文菜单式的删除确认

![终端分屏视图](./docs/images/session.png)

### 工作流自动化（Flow）

通过 Flow 功能自动化你的开发工作流：

- **树形结构**：使用文件夹和子文件夹组织工作流
- **可视化编辑器**：带行号的命令编辑器
- **自动添加行**：在最后一行输入内容时自动添加新行
- **一键运行**：在新会话中执行所有工作流命令
- **右键菜单**：快速创建、重命名、删除
- **可折叠文件夹**：保持工作流列表整洁

**Flow 功能：**
- 📁 **文件夹组织**：将相关工作流分组
- ⚡ **快速执行**：双击运行工作流
- ✏️ **内联重命名**：直接在树中编辑名称
- 🔄 **命令编辑器**：功能完整的命令序列编辑器，支持自动添加行
- 💾 **自动保存**：更改自动持久化

### 历史与日志
- **会话日志**：自动记录每个会话的命令历史
- **统计信息**：追踪记录数量、文件大小和最后活动时间
- **历史查看器**：浏览带时间戳的历史命令
- **日志管理**：按需清除单个会话历史

### 文件管理器

工作区文件浏览器，具有强大的功能：

- **多模式视图**：在当前会话、打开的标签页或所有会话之间切换
- **目录导航**：支持展开/折叠目录，懒加载内容
- **收藏夹**：固定常用目录（跨会话持久化）
- **排序选项**：按名称、大小、修改时间或创建时间排序
- **隐藏文件切换**：全局设置，支持单目录临时覆盖
- **右键菜单**：快速操作
- **横向滚动**：轻松浏览深层目录结构
- **文件详情**：显示文件大小和修改时间

![文件管理器](./docs/images/session-files-edit.png)

**文件管理器功能：**
| 功能 | 说明 |
|------|------|
| **视图模式** | 当前（活动会话）、标签页（打开的标签）、全部（所有会话） |
| **收藏夹** | ⭐ 固定目录以便快速访问，始终可见 |
| **排序方式** | 名称、大小、修改时间、创建时间（升序/降序） |
| **隐藏文件** | 设置中全局开关，右键菜单可临时切换单个目录 |
| **目录树** | 展开/折叠，根据文件类型显示图标 |
| **文件信息** | 内联显示大小和修改时间 |

**右键菜单操作：**
- 添加/移除收藏
- 显示/隐藏隐藏文件（仅当前目录）
- 折叠所有子目录
- 排序选项子菜单

### 文件查看器 (RIView)

VSCode 风格的文件编辑器，具有强大的功能：

- **工具栏操作**：保存 (💾)、格式化 (📐)、校验 (✓)、切换预览 (👁️)
- **格式支持**：JSON、YAML、XML 校验和自动格式化
- **Markdown 预览**：可拖动调整大小的左右分栏视图
- **树形视图**：可折叠的 JSON/YAML 树结构查看器
- **语法高亮**：Prism.js 驱动的多语言语法高亮
- **搜索**：文件内查找文本，支持结果导航
- **状态栏**：行数、编码、语言指示器

**如何使用：**
1. 点击侧边栏的 **⚡ Flow** 图标
2. 点击右上角的 **"📄 Open File"** 按钮
3. 在文件对话框中选择要打开的文件
4. 文件将在新标签页中以 RIView 打开

**工具栏按钮说明：**
| 按钮 | 功能 | 适用文件类型 |
|------|------|--------------|
| 💾 | 保存文件 (Cmd+S / Ctrl+S) | 所有文件 |
| 📐 | 格式化/美化代码 | JSON, YAML, XML |
| ✓ | 校验语法是否正确 | JSON, YAML, XML |
| 👁️ | 切换分栏预览 | Markdown |
| 🌳 | 切换树形视图 | JSON, YAML |
| 🔍 | 搜索文件内容 | 所有文件 |

| 功能 | JSON | YAML | XML | Markdown |
|------|------|------|-----|----------|
| 语法高亮 | ✓ | ✓ | ✓ | ✓ |
| 格式化/美化 | ✓ | ✓ | ✓ | - |
| 格式校验 | ✓ | ✓ | ✓ | - |
| 树形视图 | ✓ | ✓ | - | - |
| 实时预览 | - | - | - | ✓ (分栏) |

### 通知系统
- **实时提醒**：重要终端事件的桌面通知
- **活动监控**：追踪会话活动和命令完成
- **未读计数**：新通知的徽章指示器
- **分组显示**：按会话组织通知
- **Magic Strings**：支持终端触发的通知

### OpenCode 集成
- **自动启动**：自动启动 OpenCode 服务端和 Web 界面
- **进程管理**：独立控制服务端和 Web 进程
- **状态监控**：实时查看 PID、端口号和进程状态
- **日志流**：实时日志用于调试和监控
- **RI 通知插件**：一键安装实现无缝集成

## 技术栈

- **前端**：React 18、TypeScript
- **桌面端**：Electron 30
- **状态管理**：Zustand（统一选项卡系统）
- **终端**：xterm.js 5.2.0 配合 xterm-addon-fit
- **构建工具**：Vite 5
- **进程管理**：node-pty
- **样式**：CSS，VSCode 风格深色主题

## 环境要求

- Node.js（推荐 v18 或更高版本）
- npm 或 yarn

## 安装

```bash
# 安装依赖
npm install
```

## 开发

```bash
# 启动开发服务器（支持热重载）
npm run dev
```

此命令将：
1. 在 http://127.0.0.1:5173 启动 Vite 开发服务器
2. 等待服务器就绪
3. 以开发模式启动 Electron

## 构建

```bash
# 生产构建
npm run build
```

或者使用提供的构建脚本：
```bash
./build-app.sh
```

## 脚本命令

| 命令 | 说明 |
|------|------|
| `npm run dev` | 启动开发环境（支持热重载） |
| `npm run build` | 生产构建应用 |
| `npm start` | 启动 Electron 应用（生产模式） |
| `npm run lint` | 运行 ESLint 检查代码质量 |
| `npm test` | 运行单元测试 |
| `npm run test:e2e` | 运行端到端测试 |
| `./cleanup-processes.sh` | 清理残留的终端进程 |

## 项目结构

```
.
├── electron/                    # Electron 主进程文件
│   ├── main.cjs                # 主进程入口
│   ├── terminalManager.cjs     # 终端进程管理
│   ├── sessionLogger.cjs       # 命令历史日志
│   ├── notificationManager.cjs # 桌面通知
│   └── opencodePlugin.cjs      # OpenCode 插件管理器
├── src/
│   └── renderer/               # React 渲染进程
│       ├── components/         # React 组件
│       │   ├── Sidebar.tsx           # 图标侧边栏导航
│       │   ├── TabBar.tsx            # 统一选项卡栏
│       │   ├── Terminal.tsx          # xterm.js 终端
│       │   ├── FlowList.tsx          # 工作流树形导航
│       │   ├── FlowEditor.tsx        # 工作流命令编辑器
│       │   ├── FlowView.tsx          # Flow 主视图
│       │   ├── FileManager.tsx       # 工作区文件浏览器
│       │   ├── RIView.tsx            # VSCode 风格文件查看器/编辑器
│       │   ├── SessionList.tsx       # 会话导航列表
│       │   ├── HistoryList.tsx       # 历史会话列表
│       │   └── Settings/             # 设置组件
│       ├── store/              # Zustand 状态管理
│       └── styles/             # CSS 样式表
├── docs/                        # 文档
│   ├── images/                 # 截图和图表
│   ├── NOTIFICATIONS.md        # 通知系统详情
│   ├── NOTIFICATION_API.md     # 终端通知协议
│   └── OPENCODE_PLUGIN.md      # OpenCode 插件指南
├── test/                        # 测试文件
│   ├── e2e/                    # 端到端测试
│   └── unit/                   # 单元测试
└── README.md                   # 英文文档
```

## 使用指南

### 创建终端会话

1. 点击会话列表中的 `+` 按钮
2. 将创建一个带默认名称的新终端会话
3. 终端选项卡将自动在选项卡栏中打开
4. 你输入的第一条命令将自动为会话命名

### 管理终端会话

| 操作 | 方法 |
|------|------|
| **创建** | 点击会话列表中的 `+` 按钮 |
| **切换** | 点击列表中的会话或选项卡 |
| **重命名** | 双击会话名称 |
| **删除** | 点击删除图标 (🗑) 并确认 |
| **分屏** | 使用终端工具栏中的分屏按钮 |

**会话指示器：**
- ● (实心圆) = 会话选项卡已打开
- ○ (空心圆) = 会话存在但选项卡已关闭

### 使用工作流（Flow）

Flow 功能让你定义可重用的命令序列：

#### 创建工作流

1. 点击侧边栏的 ⚡ Flow 图标
2. 点击 `+` 按钮或右键 → "New Flow"
3. 输入工作流名称
4. 点击工作流打开编辑器
5. 每行添加一条命令
6. 点击 "Save" 或按 `Ctrl+S` / `Cmd+S`

#### 组织工作流

- **创建文件夹**：右键 → "New Folder"
- **移动项目**：拖放重新组织
- **重命名**：右键 → "Rename" 或点击编辑
- **删除**：右键 → "Delete"

#### 运行工作流

- **双击**工作流立即运行
- **点击 "▶ Run"** 按钮在 Flow 编辑器中
- 命令在新终端会话中按顺序执行

#### Flow 编辑器功能

| 功能 | 说明 |
|------|------|
| **行号** | 命令顺序的视觉参考 |
| **自动添加行** | 在最后一行输入时自动添加新行 |
| **添加命令** | 按 Enter 或点击 `+` 在任意位置插入行 |
| **删除命令** | 在空行按 Backspace 或点击 `×` |
| **重排序** | 使用 ↑↓ 按钮或拖放 |
| **工作目录** | 设置命令执行的 `cwd` |
| **快捷键** | `Ctrl+S`/`Cmd+S` 保存 |

### 查看历史

1. 点击侧边栏的 📜 历史图标
2. 浏览有命令历史的会话
3. 点击会话查看完整历史
4. 统计信息显示记录数和文件大小

### 使用文件管理器

文件管理器提供与终端会话集成的工作区文件浏览器：

#### 视图模式

| 模式 | 说明 |
|------|------|
| **当前** | 显示当前活动终端工作目录的文件 |
| **标签页** | 显示所有打开终端标签的文件 |
| **全部** | 显示所有会话的文件 |

#### 浏览文件

1. 点击会话标题展开/折叠
2. 点击目录路径展开并查看内容
3. 点击文件在 RIView 编辑器中打开
4. 使用刷新按钮 (🔄) 更新目录列表

#### 使用收藏夹

1. 右键点击任意目录
2. 选择 "⭐ Add to Favorites"
3. 收藏夹显示在顶部，始终可见
4. 通过右键菜单 → "✖ Remove from Favorites" 移除

#### 排序和过滤

右键菜单可访问排序选项：
- **排序方式**：名称、大小、修改时间、创建时间
- **排序顺序**：升序或降序
- **隐藏文件**：切换可见性（全局或单目录）

#### 设置

在 设置 → Files View 中配置默认行为：
- **显示隐藏文件**：以 `.` 开头的文件的默认可见性

### 通知

1. 点击侧边栏的 🔔 通知图标
2. 查看按会话分组的通知
3. 红色徽章显示未读数量
4. 点击标记为已读

### 设置

通过 ⚙ 图标访问设置：

| 选项卡 | 选项 |
|--------|------|
| **通知** | 桌面提醒、主题、外部集成 |
| **OpenCode** | 自动启动、插件管理 |
| **远程控制** | Discord/Slack 机器人集成远程终端控制 |
| **终端** | 字体、颜色、光标、回滚缓冲区（支持 k 单位：1k、1.5k、10k） |
| **编辑器** | 自动保存设置 |
| **文件视图** | 全局显示/隐藏隐藏文件 |
| **外观** | 主题、布局选项 |
| **高级** | 开发工具、日志、性能 |

> 注意：终端字体大小和行高已固定为最佳显示效果。

### 快捷键

| 快捷键 | 操作 |
|--------|------|
| `Ctrl+T` / `Cmd+T` | 新建终端会话 |
| `Ctrl+W` / `Cmd+W` | 关闭当前选项卡 |
| `Ctrl+Tab` | 切换到下一个选项卡 |
| `Ctrl+Shift+Tab` | 切换到上一个选项卡 |
| `Ctrl+S` / `Cmd+S` | 保存（在编辑器中） |
| `Ctrl+,` / `Cmd+,` | 打开设置 |

## 架构

### 统一选项卡系统

所有内容类型共享一个选项卡栏：

```typescript
type TabType = 'terminal' | 'flow' | 'history' | 'settings' | 'file';

interface Tab {
  id: string;
  type: TabType;
  sessionId?: string;
  flowId?: string;
  filePath?: string;
  title: string;
}
```

### 状态管理

| Store | 职责 |
|-------|------|
| `terminalStore` | 会话、选项卡、可见性 |
| `notifyStore` | 通知、已读/未读状态 |
| `configStore` | 用户偏好、设置 |
| `xtermStore` | xterm.js 实例 |

### 进程管理

- **Unix**：使用 `setsid` 和 `pkill -P` 的进程组
- **Windows**：`taskkill /T /F` 递归终止
- **清理**：通过 `before-quit` 处理程序在应用退出时自动清理

## 故障排除

### 终端黑屏

**问题**：切换选项卡后终端显示黑屏
- **原因**：xterm.js DOM 分离
- **解决**：关闭并重新打开选项卡，或切换视图

### 残留进程

**问题**：RI 关闭后进程仍在运行
- **解决**：运行 `./cleanup-processes.sh`
- **预防**：始终正确关闭 RI（不要强制退出）

### Flow 不保存

**问题**：工作流更改未持久化
- **解决**：确保点击 "Save" 或按 `Ctrl+S`
- **检查**：验证配置文件权限

## 文档

- [快速入门指南](./docs/QUICKSTART.md)
- [通知系统](./docs/NOTIFICATIONS.md)
- [通知 API](./docs/NOTIFICATION_API.md)
- [OpenCode 插件指南](./docs/OPENCODE_PLUGIN.md)
- [进程清理](./PROCESS_CLEANUP.md)

---

## 许可证

本项目为私有项目，目前未获得公开使用许可。
